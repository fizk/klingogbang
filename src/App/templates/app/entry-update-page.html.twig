{% extends '@layout/default.html.twig' %}

{% block title %}Home{% endblock %}

{% block style %}

    .drag-over {
        border: 1px solid transparent;
        padding: 16px;
    }
    .drag-over--active {
        border: 1px dashed #ced4da;
    }
    .image-list {
        list-style: none;
        padding-left: 0;
    }
    .image-list li {
        margin: 8px 0;
    }

{% endblock %}

{% block content %}
    <main>


        <form method="post" action="{{ entry.id is defined ? path('save-entry', {id: entry.id}) : path('new-entry', {}) }}">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" name="title" class="form-control" id="title" aria-describedby="title" placeholder="Title"  value="{{ entry.title is defined ? entry.title : null}}">
                    </div>
                    <script>
                        const searchAuthor = (inputEvent) => {
                            fetch(`/api/author/search?q=${inputEvent.target.value}`)
                                .then(response => response.json())
                                .then(json => {
                                    clearAuthEntries();
                                    return json;
                                })
                                .then(json => {
                                    json.forEach(item => {
                                        const template = document.querySelector('#author-search-result-item');
                                        const clone = document.importNode(template.content, true);

                                        clone.querySelector('span').appendChild(document.createTextNode(item.name));

                                        clone.querySelector('span').addEventListener('click', () => {
                                            addAuthorEntry(item.id, item.name);
                                            clearAuthEntries();
                                            inputEvent.target.value = '';
                                        });
                                        document.querySelector('[data-author-search-result]').appendChild(clone);
                                    });
                                });
                        };
                        const removeAuthorEntry = (event) => {
                            event.preventDefault();
                            const parent = event.target.parentNode;

                            parent.parentNode.removeChild(parent);

                        };
                        const clearAuthEntries = () => {
                            document.querySelector('[data-author-search-result]').innerHTML = '';
                        };
                        const addAuthorEntry = (id, name) => {
                            const template = document.querySelector('#author-entry');
                            const clone = document.importNode(template.content, true);

                            clone.querySelector('input').value = id;
                            clone.querySelector('span').appendChild(document.createTextNode(name));
                            clone.querySelector('a').addEventListener('click', removeAuthorEntry);

                            document.querySelector('[data-author-list]').appendChild(clone);
                        };
                    </script>
                    <template id="author-entry">
                        <li>
                            <input type="hidden" name="author[]">
                            <span></span>
                            <a href="#">(remove)</a>
                        </li>
                    </template>
                    <template id="author-search-result-item">
                        <li class="list-group-item">
                            <span></span>
                        </li>
                    </template>
                    <div class="form-group">
                        <label for="search">Author</label>
                        <input type="search" onkeyup="searchAuthor(event)" class="form-control" aria-describedby="search" placeholder="Search for Author..." />
                        <small id="emailHelp" class="form-text text-muted">Authors are created <a href="{{ path('create-author') }}" target="_blank">here</a></small>
                        <ul data-author-search-result class="list-group"></ul>
                    </div>
                    <ul data-author-list>
                        {% if entry.authors is defined %}
                            {% for author in entry.authors %}
                                <li>
                                    <input type="hidden" name="author[]" value="{{ author.id }}">
                                    <span>{{ author.name }}</span>
                                    <a href="#" onclick="removeAuthorEntry(event)">(remove)</a>
                                </li>
                            {% endfor %}
                        {% endif %}
                    </ul>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="from">From</label>
                        <input type="date" name="from" class="form-control" id="from" aria-describedby="from" value="{{ entry.from is defined ? entry.from : null}}">
                    </div>
                    <div class="form-group">
                        <label for="to">To</label>
                        <input type="date" name="to" class="form-control" id="to" aria-describedby="to" value="{{ entry.to is defined ? entry.to : null}}">
                    </div>
                    <div class="form-group">
                        <label for="type">Type</label>
                        <select class="form-control" id="type" name="type">
                            <option value="show" {{ entry.type is defined and entry.type == 'show' ? 'selected' : '' }} >Show</option>
                            <option value="news" {{ entry.type is defined and entry.type == 'news' ? 'selected' : '' }}>News</option>
                        </select>
                    </div>
                    {% if entry.id is defined %}
                        <a href="{{ path('delete-entry', {id: entry.id}) }}" class="btn btn-danger">Delete</a>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label for="body">Body</label>
                <textarea class="form-control" id="body" name="body" rows="8">{{ entry.body is defined ? entry.body : null}}</textarea>
                <small id="emailHelp" class="form-text text-muted">This field supports <a target="_blank" href="https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet">markdown</a></small>
            </div>

            <div class="row">
                <script>
                    const onDropPoster = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        uploadImages(
                            event.dataTransfer.files,
                            '[data-poster]',
                            '[data-poster-progress-bar]',
                            '[data-poster-progress-bar-text]',
                            '#poster-result-entry'
                        );
                    };
                    const onDropGallery = (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        uploadImages(
                            event.dataTransfer.files,
                            '[data-gallery]',
                            '[data-gallery-progress-bar]',
                            '[data-gallery-progress-bar-text]',
                            '#gallery-result-entry'
                        );
                    };
                    const selectPoster = (event) => {
                        event.preventDefault();
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.multiple = true;
                        input.accept = 'image/*';
                        input.style.position = 'absolute';
                        input.style.top = '-100px';
                        input.addEventListener('change', (event) => {
                            event.preventDefault();
                            uploadImages(
                                event.target.files,
                                '[data-poster]',
                                '[data-poster-progress-bar]',
                                '[data-poster-progress-bar-text]',
                                '#poster-result-entry'
                            )
                        });
                        document.body.appendChild(input);
                        input.click();
                    };
                    const selectGallery = (event) => {
                        event.preventDefault();
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.multiple = true;
                        input.accept = 'image/*';
                        input.style.position = 'absolute';
                        input.style.top = '-100px';
                        input.addEventListener('change', (event) => {
                            event.preventDefault();
                            uploadImages(
                                event.target.files,
                                '[data-gallery]',
                                '[data-gallery-progress-bar]',
                                '[data-gallery-progress-bar-text]',
                                '#gallery-result-entry'
                            )
                        });
                        document.body.appendChild(input);
                        input.click();
                    };
                </script>
                <div class="col">
                    <label for="body">Poster</label>
                    <template id="poster-result-entry">
                        <li>
                            <input type="hidden" name="poster[]" />
                            <img src="#" />
                            <span></span>
                            <a href="#" onclick="removePoster(event)">(remove)</a>
                        </li>
                    </template>
                    <div class="form-group drag-over"
                         ondrop="onDropPoster(event)"
                         ondragover="isDragOver(event)"
                         ondragenter="isDragOver(event)"
                         ondragleave="isNotDragOver(event)"
                         ondragend="isNotDragOver(event)">

                        <p>
                            <a href="#" onclick="selectPoster(event)">Select or drag images</a>
                        </p>
                        <div class="progress" style="height: 2px;">
                            <div class="progress-bar" data-poster-progress-bar
                                 role="progressbar" style="width: 0%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small data-poster-progress-bar-text class="form-text text-muted">&nbsp;</small>

                        <ul data-poster class="image-list">
                            {% if entry.poster is defined and entry.poster.name is defined %}
                                <li>
                                    <input type="hidden" name="poster[]" value="{{ entry.poster.id }}">
                                    <img src="/img/thumb/{{ entry.poster.name }}" />
                                    <span>{{ entry.poster.name }}</span>
                                    <a href="#" onclick="removePoster(event)">(remove)</a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="col">
                    <label for="body">Gallery</label>
                    <template id="gallery-result-entry">
                        <li>
                            <input type="hidden" name="gallery[]" />
                            <img src="#" />
                            <span></span>
                            <a href="#" onclick="removePoster(event)">(remove)</a>
                        </li>
                    </template>
                    <div class="form-group drag-over"
                         ondrop="onDropGallery(event)"
                         ondragover="isDragOver(event)"
                         ondragenter="isDragOver(event)"
                         ondragleave="isNotDragOver(event)"
                         ondragend="isNotDragOver(event)">
                        <p>
                            <a href="#" onclick="selectGallery(event)">Select or drag images</a>
                        </p>
                        <div class="progress" style="height: 2px;">
                            <div class="progress-bar" data-gallery-progress-bar
                                 role="progressbar" style="width: 0" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small data-gallery-progress-bar-text class="form-text text-muted">&nbsp;</small>

                        <ul data-gallery class="image-list">
                            {% if entry.gallery is defined %}
                                {% for image in entry.gallery %}
                                    <li>
                                        <input type="hidden" name="gallery[]" value="{{ image.id }}">
                                        <img src="/img/thumb/{{ image.name }}" />
                                        <span>{{ image.name }}</span>
                                        <a href="#" onclick="removePoster(event)">(remove)</a>
                                    </li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                    </div>

                </div>
            </div>

            <button type="submit" class="btn btn-primary">Submit</button>
            {% if entry.id is defined %}
                <a href="{{ path('entry', {id: entry.id}) }}">Cancel</a>
            {% else %}
                <a href="{{ path('update') }}">Cancel</a>
            {% endif %}
        </form>

    </main>
{% endblock %}
